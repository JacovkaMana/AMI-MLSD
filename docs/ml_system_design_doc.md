# ML System Design Doc - [RU]

## Дизайн ML системы - AMI (Adventure Management Interface) MVP 1.0


### 1. Цели и предпосылки 
#### 1.1. Зачем идем в разработку продукта?  

- Бизнес-цель: Создание интерактивной системы для генерации и управления историями, которая позволит пользователям получить уникальный опыт погружения в проработанные вымышленные миры.
- Почему станет лучше, чем сейчас, от использования ML: Благодаря применению мультиагентной системы на основе ML, генерируемые миры, персонажи и сюжеты будут отличаться высокой степенью проработки, внутренней согласованностью и адаптивностью к действиям пользователя, что недостижимо при использовании традиционных предзаданных сценариев.
- Что будем считать успехом итерации с точки зрения бизнеса: Создание работающего прототипа с возможностью генерации цельного мира с 3-5 персонажами и простой сюжетной линией, который получит положительные отзывы от тестовой группы пользователей.

#### 1.2. Бизнес-требования и ограничения  

- Краткое описание БТ: Система должна генерировать детализированные миры с собственной историей и мифологией, создавать разнообразных персонажей с уникальными характеристиками, формировать динамические сюжетные линии и обеспечивать взаимодействие пользователя с миром.
- Бизнес-ограничения: Создаваемый контент должен соответствовать возрастным ограничениям 12+, система должна работать в рамках заданных вычислительных ресурсов и обеспечивать отклик не более 5 минут на типичные действия пользователя.
- Что мы ожидаем от конкретной итерации: Работающий прототип с базовым функционалом всех ключевых агентов для демонстрации концепции потенциальным инвесторам и получения обратной связи от тестовой группы.
- Описание бизнес-процесса пилота: Тестовая группа пользователей получит доступ к системе, где им будет предложено создать персонажа и пройти сгенерированное приключение. По итогам взаимодействия будет собрана обратная связь о качестве генерируемого контента и удобстве взаимодействия.
- Что считаем успешным пилотом: 70% тестовых пользователей положительно оценивают качество генерируемого контента, степень погружения и желают продолжить использование системы.

#### 1.3. Что входит в скоуп проекта/итерации, что не входит   

- На закрытие каких БТ подписываемся в данной итерации: Создание базовой мультиагентной архитектуры (конкретный набор агентов будет определен в процессе проектирования), генерация текстовых описаний мира и персонажей, формирование простых сюжетных линий с возможностью базового взаимодействия пользователя.
- Что не будет закрыто: Генерация изображений локаций и персонажей, сложные ветвящиеся сюжеты, полноценная система диалогов.
- Описание результата с точки зрения качества кода и воспроизводимости решения: Модульная архитектура с четким разделением ответственности между агентами, документированный код, возможность легкого расширения функциональности в будущих итерациях.
- Описание планируемого технического долга: Оптимизация производительности для обработки более сложных сценариев, интеграция с системами визуализации, доработка механизмов для более естественного восприятия вводимых пользователем команд и запросов.

#### 1.4. Предпосылки решения  

- Описание всех общих предпосылок решения: Мы будем использовать предобученные языковые модели для генерации текстового контента, с возможностью дообучения на специализированных текстах. Архитектура системы будет опираться на концепцию мультиагентного взаимодействия, где AMI выступает в роли Главного агента, который напрямую взаимодействует с пользователем и координирует работу других специализированных агентов. Для хранения и управления состоянием истории будем использовать графовую базу данных для отслеживания взаимосвязей между элементами мира.

### 2. Методология  

#### 2.1. Постановка задачи  

- С технической точки зрения нам необходимо создать систему генерации текста специфического домена, обеспечить когерентность и целостность создаваемого контента через мультиагентную архитектуру, реализовать механизмы для адаптивной генерации сюжета на основе действий пользователя. Основные компоненты включают системы генерации мира, персонажей и сюжета, а также механизмы обработки естественного языка для взаимодействия с пользователем.

#### 2.2. Блок-схема решения  

- Базовая архитектура AMI включает следующие компоненты:
  1. Интерфейс пользователя (UI) - для ввода команд и отображения генерируемого контента
  2. AMI (Главный агент) - напрямую взаимодействует с пользователем и координирует работу специализированных агентов
  3. Мультиагентная система - набор специализированных агентов, состав которых будет определен в процессе исследований и проектирования
  4. База данных - хранит состояние мира, персонажей и сюжета

- Бейзлайн: использование единой модели для генерации всего контента без разделения на агентов
- MVP: мультиагентная система с разделением ответственности между специализированными агентами

#### 2.3. Этапы решения задачи  

*Этап 1 - Подготовка данных*

- **Данные и сущности, на которых будет обучаться модель машинного обучения:**

  | Название данных              | Есть ли данные в компании | Требуемый ресурс для получения данных       | Проверено ли качество данных |
  |------------------------------|---------------------------|---------------------------------------------|------------------------------|
  | Корпус фэнтезийной литературы | Нет, необходимо собрать   | Data Engineer, NLP специалист               | -                            |
  | Примеры описаний миров       | Нет, необходимо собрать   | Data Engineer, Game Designer                | -                            |
  | Примеры персонажей           | Нет, необходимо собрать   | Data Engineer, Game Designer                | -                            |
  | Примеры сюжетных линий       | Нет, необходимо собрать   | Data Engineer, Game Designer                | -                            |
  | Примеры диалогов             | Нет, необходимо собрать   | Data Engineer, Game Designer                | -                            |
  | **Нарративные данные**       | **Да, получены**          | **NLP специалист для обработки**            | **Необходимо проверить**     |

- **Результат этапа:** Собранные и структурированные наборы данных для каждого типа контента (миры, персонажи, сюжеты, диалоги) с четкой категоризацией и разметкой. Дополнительно, **наративные данные** будут использованы для обучения агентов, в частности, для улучшения их способности генерировать связные и контекстуально релевантные диалоги и описания. Эти данные также послужат основой для формирования промптов и контекстных примеров при работе с предобученной языковой моделью, что позволит генерировать более качественный и разнообразный контент без необходимости дополнительного обучения модели. API-интерфейсы будут интегрированы для автоматизации сбора и обработки данных, а также для использования внешних сервисов генерации текста при необходимости.

*Этап 2 - Разработка базовой архитектуры мультиагентной системы*

- **Для MVP:** Создание набора специализированных агентов для генерации контента с использованием предобученных языковых моделей. Каждый агент (World, Character, Location, Storyteller) реализует метод `execute_task` для обработки запросов. Использование внутренних инструментов (tools) для получения справочных данных. Простая архитектура взаимодействия через прямые вызовы методов без сложных протоколов обмена данными.
  
- **Для бейзлайна:** Создание монолитной системы с единой моделью для всех задач генерации.
  
- **Метрики качества:**
  - Время отклика системы (не более 5 минут)
  - Оценка связности генерируемого контента экспертами (не менее 7/10)
  - Автоматическая оценка согласованности с использованием LLM-судьи (не менее 8/10 по заранее определенным критериям)
  
- **Риски:** Ограниченная координация между агентами, потенциальная несогласованность генерируемого контента. Решение через стандартизацию форматов данных и добавление супервизора для проверки согласованности.

*Этап 3 - Разработка агентов для управления миром*

- **Для MVP:** Создание World Agent, генерирующего описания мира на основе задач пользователя. Агент использует инструмент Donjon для получения справочных данных и языковую модель (Mistral) для генерации описаний. Отказ от графовой модели в пользу простого текстового представления.
  
- **Для бейзлайна:** Генерация статического мира без возможности динамических изменений.
  
- **Метрики качества:** Связность описаний (оценка экспертами, не менее 7/10), скорость генерации (не более 2 минуты на описание мира).
  
- **Риски:** Поверхностность описаний, шаблонность. Решение через улучшение промптов и расширение справочных данных.

*Этап 4 - Разработка агентов для управления персонажами*

- **Для MVP:** Создание Character Agent, генерирующего описания персонажей на основе задач пользователя. Агент использует инструмент Donjon для получения справочных данных о персонажах и языковую модель (Mistral) для генерации описаний. Отказ от сложных механизмов управления поведением в MVP.
  
- **Для бейзлайна:** Генерация персонажей по фиксированным шаблонам.
  
- **Метрики качества:** Уникальность персонажей (не менее 70% различий в ключевых характеристиках), скорость генерации (не более 30 секунд на персонажа).
  
- **Риски:** Шаблонность персонажей, поверхностные описания. Решение через расширение справочных данных и улучшение промптов.

*Этап 5 - Разработка агентов для управления сюжетом*

- **Для MVP:** Исследование и создание набора агентов для генерации сюжетных линий с учетом мира и персонажей. **Использование наративных данных для обучения агентов создавать увлекательные и адаптивные сюжеты**. Реализация механизмов для адаптации сюжета к действиям пользователя с возможностью интеграции API для динамической генерации сюжетных поворотов.
  
- **Для бейзлайна:** Генерация линейного сюжета без возможности ветвления.
  
- **Метрики качества:** Адаптивность сюжета (количество значимых изменений в ответ на действия пользователя, не менее 5 на сессию), увлекательность (оценка пользователями, не менее 7/10).
  
- **Риски:** Линейность сюжета, предсказуемость, возможные задержки при использовании API для генерации сюжетных элементов. Планируем использовать динамические сюжетные шаблоны, механизмы неожиданных поворотов и кэширование API-ответов для ускорения работы.

*Этап 6 - Разработка агентов для взаимодействия с пользователем*

- **Для MVP:** Исследование и создание набора агентов для обработки ввода пользователя и интеграции его действий в мир и сюжет. Реализация базового набора команд и действий.
  
- **Для бейзлайна:** Обработка ограниченного набора предопределенных команд.
  
- **Метрики качества:** Процент успешно распознанных команд пользователя (не менее 85%), естественность ответов системы (оценка пользователями, не менее 7/10).
  
- **Риски:** Ограниченное понимание естественного языка, шаблонные ответы. Планируем расширять набор понимаемых команд на основе тестирования.

*Этап 7 - Интеграция и тестирование*

- **Для MVP и бейзлайна:** Интеграция агентов в единую систему через главный модуль. Проведение тестирования на согласованность вывода агентов. Устранение основных ошибок взаимодействия.
  
- **Метрики качества:** Стабильность системы (не более 1 сбоя на 50 взаимодействий), общая оценка пользовательского опыта (не менее 6/10).
  
- **Риски:** Несогласованность между агентами, конфликтующие описания. Решение через добавление супервизора для координации вывода.



### 3. Подготовка пилота  
  
#### 3.1. Способ оценки пилота  

- Тестовой группе из 20-30 пользователей будет предоставлен доступ к системе на 2 недели. Пользователи будут создавать персонажей и проходить сгенерированные приключения. После каждой сессии будут собираться количественные метрики (время взаимодействия, количество сгенерированных сюжетных точек, скорость генерации) и качественная обратная связь через опросники. Также будут проведены интервью с частью пользователей для получения более детальной обратной связи.

#### 3.2. Что считаем успешным пилотом  

- Количественные метрики:
  - Среднее время генерации сюжетной точки не более 1 минуты
  - Не менее 80% сгенерированных сюжетов оцениваются пользователями положительно
  - Не менее 60% пользователей возвращаются для повторных сессий
  - Средняя оценка качества генерируемого контента не менее 7/10
  - Средняя оценка удобства взаимодействия не менее 6/10
- Качественные метрики:
  - Положительные отзывы о целостности и увлекательности генерируемых миров и историй
  - Желание пользователей увидеть дальнейшее развитие системы

#### 3.3. Подготовка пилота  

- Исходя из ожидаемых вычислительных затрат, для пилота будем использовать предобученные модели среднего размера с оптимизацией для быстрого инференса. Планируем эксперименты с бейзлайном для оценки необходимых вычислительных ресурсов и установления ограничений для MVP. По результатам экспериментов может потребоваться оптимизация архитектуры для обеспечения приемлемого времени отклика.

### 4. Внедрение  
  
#### 4.1. Архитектура решения   

- Система реализована как консольное приложение с модульной архитектурой:
  - Главный модуль: Координация работы системы
  - Мультиагентная система: Набор специализированных агентов (World, Character, Location, Storyteller)
  - Инструменты (tools): Внутренние инструменты для получения справочных данных (Donjon)
  - Модели языка: Прямая интеграция с LLM через llm.py
  - Хранение данных: Временное хранение в памяти без постоянной базы данных

#### 4.2. Описание инфраструктуры и масштабируемости 

- Текущая инфраструктура: Монолитное консольное приложение.
- Плюсы: Простота разработки и тестирования, низкие эксплуатационные затраты.
- Минусы: Ограниченная масштабируемость, отсутствие отказоустойчивости.
- Планы по масштабированию: Переход на микросервисную архитектуру в будущих итерациях при увеличении нагрузки.

#### 4.3. Требования к работе системы  

- SLA: 99.5% доступность в рабочие часы (9:00-21:00)
- Пропускная способность: Система должна выдерживать нагрузку от 30 одновременных запросов в секунду
- Задержка: Не более 2 минут для типичных действий пользователя, не более 15 минут для генерации новых элементов мира или сюжета

#### 4.4. Безопасность системы  

- Потенциальные уязвимости:
  - Возможность инъекций вредоносного контента через пользовательский ввод
  - Эксплуатация языковой модели для генерации неприемлемого контента
  - Перегрузка системы злоумышленными запросами

- Меры противодействия:
  - Фильтрация пользовательского ввода
  - Системы мониторинга и анализа генерируемого контента
  - Ограничение частоты запросов от одного пользователя

#### 4.5. Безопасность данных   

- Система не собирает персональные данные пользователей, кроме базовой информации для аутентификации и истории взаимодействия с системой.
- Все данные пользователей будут храниться в зашифрованном виде.
- Предусмотрена функция экспорта и удаления пользовательских данных по запросу.

#### 4.6. Издержки  

- Расчетные месячные издержки для пилотной версии:
  - Облачная инфраструктура: ~20 000₽
    - 2 виртуальные машины для бэкенда (8 CPU, 32GB RAM): 15 000₽
    - Мониторинг и логирование: 5 000₽
  - Использование API языковых моделей: ~35 000₽
    - Базовая генерация текста (1M токенов): 20 000₽
    - Дополнительные запросы к специализированным моделям: 15 000₽
  - Хранение данных: ~5 000₽
    - Neo4j база данных (50GB): 4 000₽
    - Резервное копирование: 1 000₽
Общие расходы: ~60 000₽ в месяц

Примечание: Расчеты основаны на текущих ценах облачных провайдеров и API. Фактические расходы могут варьироваться в зависимости от реальной нагрузки и оптимизации использования ресурсов.

#### 4.7. Integration points  

- Основные точки интеграции:
  - API для взаимодействия между фронтендом и бэкендом
  - API для взаимодействия между агентами и языковыми моделями
  - Интерфейсы для взаимодействия между агентами
  - Интерфейсы для взаимодействия с базой данных

#### 4.8. Риски  

- Технические риски:
  - Недостаточная производительность выбранных языковых моделей
  - Проблемы с согласованностью генерируемого контента между разными агентами
  - Сложность масштабирования при увеличении числа пользователей

- Продуктовые риски:
  - Неудовлетворенность пользователей качеством генерируемого контента
  - Быстрая потеря интереса пользователей из-за недостаточного разнообразия
  - Сложности в монетизации продукта

- Меры снижения рисков:
  - Итеративная разработка с частой обратной связью от пользователей
  - Резервирование ресурсов для быстрого улучшения проблемных аспектов
  - Подготовка альтернативных подходов к генерации контента
